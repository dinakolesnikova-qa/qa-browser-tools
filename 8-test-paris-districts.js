/**
 * üó∫Ô∏è TEST: PARIS DISTRICT VALIDATOR (Full Precision)
 * Checks every hotel against 5 Polygons.
 * OUTPUT: Table with EXACT Lat/Lon (no rounding) + Zone ID.
 */

// ==========================================
// üìù CONFIGURATION: THE DISTRICTS
// ==========================================

const DISTRICTS = {
    "Le Marais": [
        [2.35513691697286,48.86429168670914],[2.35067859121191,48.85586036208678],[2.361825240084907,48.85093239382361],[2.369199692123389,48.85304568994903],[2.366870615980561,48.86300537103852],[2.364705191195617,48.86645722377805],[2.363223412396596,48.86717628318099],[2.361602267067298,48.86651347289754],[2.358186720413491,48.8633789545982],[2.35513691697286,48.86429168670914]
    ],
    "St. Germain": [
        [2.335878968609726,48.85311663400202],[2.338870754120677,48.85239662061829],[2.337121132623654,48.85704820880768],[2.336612638571369,48.85711701118969],[2.336338005011875,48.85767013675313],[2.333316579938101,48.85828532879827],[2.329373192833126,48.85270475396989],[2.3285468893118,48.85182425853804],[2.335878968609726,48.85311663400202]
    ],
    "9th Arr.": [
        [2.325872343319544,48.86945673566119],[2.339955383431902,48.87194661527656],[2.348057899107283,48.87063064962449],[2.347961981880562,48.87398897432257],[2.348338603139801,48.87576813494904],[2.349185074621349,48.87722849833949],[2.349575184606965,48.87971341830767],[2.349952931466217,48.88107621928645],[2.349630780879131,48.88367618245207],[2.343759196080024,48.88287370740519],[2.339844588473274,48.88202920844689],[2.329740112068202,48.8844661186582],[2.32715724583457,48.88336058824905],[2.326791579493164,48.87546762970309],[2.327069607527779,48.87384744638508],[2.325981539471504,48.87058348969568],[2.325872343319544,48.86945673566119]
    ],
    "Greater Paris": [
        [2.275286032395145,48.81847344526555],[2.321812236328333,48.80767924035359],[2.374833762623467,48.81054612348598],[2.41057930690125,48.81998482227684],[2.423897897540965,48.8304419472033],[2.418052113715596,48.84742420941764],[2.413707635425018,48.8753037657623],[2.401764989028985,48.88386897949558],[2.400600771018049,48.88995027356422],[2.390898375441508,48.90237753122231],[2.377760035461691,48.9015868728141],[2.316398509568709,48.90057933456314],[2.254371756292468,48.88336955249383],[2.226865889841003,48.86423914992852],[2.221854877168177,48.83801800429439],[2.231386137621685,48.82440882839319],[2.275286032395145,48.81847344526555]
    ],
    "Champs & West": [
        [2.279931454137503,48.86021919649331],[2.298152269213225,48.85056359151986],[2.331164516902304,48.84871264859257],[2.372337954836767,48.84507715717517],[2.393988830058384,48.84671608664156],[2.390763635518949,48.85795538682246],[2.380912976570249,48.86602892513199],[2.3483721108098,48.88428050789823],[2.301261853117016,48.89553522476207],[2.278361193046168,48.88936570482191],[2.273740454563626,48.87715438674307],[2.279931454137503,48.86021919649331]
    ]
};

// ==========================================

// --- STEP 1: CONNECT TO SPY ---
const allHotels = window.allCapturedHotels || [];

if (allHotels.length === 0) {
    console.error("‚ùå No hotels found! Run '1-network-spy.js' first.");
} else {
    console.log(`üéØ Analyzing ${allHotels.length} hotels against 5 Districts...`);

    // --- MATH: POINT IN POLYGON ---
    function isPointInPolygon(latitude, longitude, polygon) {
        let x = longitude, y = latitude;
        let inside = false;
        for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
            let xi = polygon[i][0], yi = polygon[i][1];
            let xj = polygon[j][0], yj = polygon[j][1];
            let intersect = ((yi > y) != (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
            if (intersect) inside = !inside;
        }
        return inside;
    }

    // --- PROCESS TABLE DATA ---
    const tableData = allHotels.map((hotel, index) => {
        const hLat = hotel.address?.coordinates?.latitude;
        const hLon = hotel.address?.coordinates?.longitude;
        const zoneId = hotel.leisureSearchPriorityZoneId || "NULL";

        // Show FULL PRECISION (No toFixed)
        // Just combine them into a string directly
        const coordString = (hLat && hLon) ? `${hLat}, ${hLon}` : "N/A";

        // Basic Row Info
        const row = {
            "Rank": index + 1,
            "Name": hotel.name,
            "Zone ID": zoneId, 
            "Lat/Lon": coordString
        };

        // Check against EVERY district
        for (const [districtName, polyCoords] of Object.entries(DISTRICTS)) {
            let match = "N";
            if (hLat && hLon) {
                if (isPointInPolygon(hLat, hLon, polyCoords)) {
                    match = "‚úÖ Y";
                }
            }
            row[districtName] = match;
        }

        return row;
    });

    // --- PRINT TABLE ---
    console.log("\nüìã PARIS DISTRICT MATRIX REPORT (Full Precision)");
    console.table(tableData);
}
